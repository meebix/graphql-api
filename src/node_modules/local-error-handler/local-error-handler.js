const appFormatter = require('./formatters/app-formatter');
const knexFormatter = require('./formatters/knex-formatter');
const sparkPostFormatter = require('./formatters/sparkpost-formatter');
const jwtFormatter = require('./formatters/jwt-formatter');
const stripeFormatter = require('./formatters/stripe-formatter');
const defaultFormatter = require('./formatters/default-formatter');

/**
 * Determines the specific library error signature to be formatted
 *
 * @function
 * @param {Object} error - Express.js err
 * @returns {Object} - Formatted error object to be passed to formatError
 */
function formatError(err) {
  let name = err.name;

  // When err.name is generic like "Error", need to be more selective
  if (err.name === 'Error' && (err.sqlState || err.sqlMessage)) name = 'KnexError';
  if (err.name === 'Error' && (err.type && err.type.startsWith('Stripe'))) name = 'StripeError';

  switch (name) {
    case 'AppError':
    case 'ValidationError':
      return appFormatter(err);
    case 'KnexError':
      return knexFormatter(err);
    case 'SparkPostError':
      return sparkPostFormatter(err);
    case 'TokenExpiredError':
    case 'JsonWebTokenError':
      return jwtFormatter(err);
    case 'StripeError':
      return stripeFormatter(err);
    default:
      return defaultFormatter(err);
  }
}

module.exports = formatError;
